# ComfyUI-云岚AI

一个功能丰富的ComfyUI自定义节点集合，专注于AI对话和智能图像处理功能。

## 功能特点

- **AI对话节点**: 支持多种AI模型的对话功能，可处理文本和图像输入
- **智能选择节点**: 提供动态图像选择和文本选择功能
- **图像处理节点**: 提供图像拼接和组合功能
- **提示词管理**: 内置提示词管理系统，支持动态加载和保存
- **自定义UI**: 美观的节点样式和交互界面
- **易于扩展**: 模块化设计，便于添加新功能

## 安装方法

### 方法一：使用ComfyUI Manager（推荐）

1. 在ComfyUI中安装并启用ComfyUI Manager
2. 在Manager中搜索"云岚AI"、"yunlan5423"或"comfyui-yunlan"
3. 点击安装，Manager会自动下载并安装所有依赖
4. 重启ComfyUI即可使用

### 方法二：手动安装

```bash
cd /path/to/ComfyUI/custom_nodes
git clone https://github.com/yunlan5423/comfyui_yunlan.git
cd comfyui_yunlan
# 安装依赖
pip install -r requirements.txt
```

## 节点介绍

### AI对话节点

- **云岚_AI对话**: 支持多种AI模型的对话功能
  - 支持文本和图像输入
  - 可配置不同的AI模型（GPT-4、GPT-3.5、Gemini等）
  - 内置提示词管理系统
  - 支持多图像同时输入
  - 支持随机种子和固定种子功能
  - 安全的文本处理，防止界面错乱
  - 自动清理特殊字符和HTML标签

### 智能选择节点

- **云岚_条件选图**: 动态图像选择器
  - 支持多个图像输入端口
  - 动态添加输入端口
  - 智能索引选择

- **云岚_条件选词**: 动态文本选择器
  - 支持多个文本输入端口
  - 动态添加输入端口
  - 智能索引选择

### 图像处理节点

- **云岚_拼图**: 图像拼接节点
  - 支持上下左右四个方向拼接
  - 自动调整图像尺寸
  - 保持纵横比

## 使用示例

### AI对话示例

1. 添加"云岚_AI对话"节点
2. 在设置中配置API Key和API URL
3. 选择AI模型和提示词
4. 设置种子模式（随机或固定）
5. 设置种子值（当选择固定模式时）
6. 可选择连接图像输入
7. 输入附加文本
8. 获得AI生成的文本回复

#### 种子功能说明

- **随机种子**: 每次运行都会生成不同的随机种子，确保AI回复的多样性
  - 执行完成后会自动更新UI中的种子值
  - 下次运行时会使用新的随机种子
- **固定种子**: 使用指定的种子值，在相同输入下可以获得一致的AI回复
  - 种子值保持不变，确保结果可重现
- 种子值范围: 0 到 18446744073709551615
- **自动刷新**: 随机模式下，每次执行后种子会自动更新到UI界面

### 图像选择示例

1. 添加"云岚_条件选图"节点
2. 连接多个图像到输入端口
3. 设置选择索引
4. 输出选中的图像

### 图像拼接示例

1. 添加"云岚_拼图"节点
2. 连接原图和要拼接的图片
3. 选择拼接方向（上、下、左、右）
4. 设置原图最大尺寸
5. 获得拼接后的图像

## 配置说明

### API设置

在使用AI对话功能前，需要配置API设置：

1. API URL: 设置AI服务的API地址
2. API Key: 设置有效的API密钥
3. 模型列表: 配置可用的AI模型列表

### 提示词管理

支持自定义提示词管理：

1. 可以添加、编辑、删除提示词
2. 支持分类管理
3. 提示词会自动保存到本地

## 开发指南

### 项目结构

```
comfyui_yunlan/
├── nodes/             # Python节点代码
│   ├── api_nodes.py   # AI对话和智能选择节点
│   └── template_node.py # 节点模板
├── js/                # 前端JavaScript代码
│   ├── yunlanfy.js    # 前端界面和交互
│   └── prompt_manager.js # 提示词管理
├── __init__.py        # 插件入口文件
├── settings.json      # API设置配置
├── prompts.json       # 提示词配置
├── requirements.txt   # 依赖包列表
└── README.md          # 项目说明
```

### 添加新节点

1. 在`nodes`目录创建新的Python文件或在现有文件中添加新节点类
2. 遵循ComfyUI节点的格式规范编写节点类
3. 在节点类中定义`INPUT_TYPES`、`RETURN_TYPES`和执行函数
4. 在文件底部注册节点到`NODE_CLASS_MAPPINGS`和`NODE_DISPLAY_NAME_MAPPINGS`

### 前端自定义

在`js/yunlanfy.js`中可以添加自定义UI组件和交互逻辑。

## ComfyUI Manager 支持

本插件完全支持ComfyUI Manager，包含以下特性：

- ✅ 自动依赖安装
- ✅ 节点信息自动识别
- ✅ 一键安装和卸载
- ✅ 版本管理
- ✅ 更新检查

### 节点信息

| 节点名称 | 功能描述 | 分类 |
|---------|---------|------|
| 云岚_AI对话 | 支持多种AI模型的对话功能 | 云岚AI |
| 云岚_条件选图 | 动态图像选择器 | 云岚AI |
| 云岚_条件选词 | 动态文本选择器 | 云岚AI |
| 云岚_拼图 | 图像拼接节点 | 云岚AI |

## 依赖要求

- Python 3.7+
- ComfyUI
- openai >= 1.0.0
- requests >= 2.25.0
- Pillow >= 8.0.0
- torch（通常由ComfyUI提供）
- numpy（通常由ComfyUI提供）

## 许可证

MIT

## 联系方式

GitHub: [https://github.com/yunlan5423/comfyui_yunlan](https://github.com/yunlan5423/comfyui_yunlan)

如有问题或建议，请提交Issue或PR。